import subprocess
from urllib.parse import urlparse

import pyrogram
from pyrogram import Client, filters
from pyrogram.errors import UsernameNotOccupied
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import cv2
from moviepy import VideoFileClip

import time
import os
import threading
import json

with open('config.json', 'r') as f:
    DATA = json.load(f)


def getenv(var):
    return os.environ.get(var) or DATA.get(var, None)


api_id = int(getenv("ID"))
api_hash = getenv("HASH")
bot_token = getenv("TOKEN")
allowed_users = getenv("ALLOWED_USERS").split(",")
save_to_chat_id = int(getenv("SAVE_TO_CHAT_ID"))
save_to_topic_id_document = int(getenv("SAVE_TO_TOPIC_ID_DOCUMENT"))
save_to_topic_id_video = int(getenv("SAVE_TO_TOPIC_ID_VIDEO"))
save_to_topic_id_photo = int(getenv("SAVE_TO_TOPIC_ID_PHOTO"))

os.makedirs('./sessions', exist_ok=True)

bot = Client('./sessions/bot', api_id=api_id, api_hash=api_hash, bot_token=bot_token)

# ç”¨äºè®°å½•æ¯ä¸ªæ¶ˆæ¯çš„ä¸Šä¼ /ä¸‹è½½è¿›åº¦æ—¶é—´ä¸å­—èŠ‚æ•°
last_update_time = {}
last_update_bytes = {}


def is_allowed_user(message: pyrogram.types.messages_and_media.message.Message):
    if str(message.from_user.id) not in allowed_users:
        bot.send_message(message.chat.id, "é‰´æƒå¤±è´¥", reply_to_message_id=message.id)
        return False

    try:
        bot.get_chat(save_to_chat_id)
    except:
        bot.send_message(message.chat.id, "è¯·å…ˆå°†æœºå™¨äººåŠ å…¥æŒ‡å®šç¾¤ç»„æˆ–é¢‘é“ï¼Œå¹¶ä½¿ç”¨ä»»æ„è´¦å·åœ¨è¯¥ç¾¤ç»„æˆ–é¢‘é“å‘è¨€ä¸€æ¬¡ã€‚",
                         reply_to_message_id=message.id)
        return False

    # if len(last_update_time) >= 4:
    #     bot.send_message(message.chat.id, "è¯·å…ˆç­‰å¾…å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚", reply_to_message_id=message.id)
    #     return False

    return True


def sizeof_fmt(num, suffix='B'):
    for unit in ['', 'K', 'M', 'G', 'T', 'P']:
        if abs(num) < 1024.0:
            return f"{num:.2f} {unit}{suffix}"
        num /= 1024.0
    return f"{num:.2f} P{suffix}"


# ä¸‹è½½çŠ¶æ€å‡½æ•°
def downstatus(statusfile, message):
    while True:
        if os.path.exists(statusfile):
            break

    time.sleep(3)
    while os.path.exists(statusfile):
        with open(statusfile, "r") as downread:
            txt = downread.read()
        try:
            bot.edit_message_text(message.chat.id, message.id, f"__æ­£åœ¨ä¸‹è½½__ : **{txt}**")
            time.sleep(3)
        except:
            time.sleep(5)


# ä¸Šä¼ çŠ¶æ€
def upstatus(statusfile, message):
    while True:
        if os.path.exists(statusfile):
            break

    time.sleep(3)
    while os.path.exists(statusfile):
        with open(statusfile, "r") as upread:
            txt = upread.read()
        try:
            bot.edit_message_text(message.chat.id, message.id, f"__æ­£åœ¨ä¸Šä¼ __ : **{txt}**")
            time.sleep(3)
        except:
            time.sleep(5)


# è¿›åº¦å†™å…¥å‡½æ•°
def progress(current, total, message, type):
    now = time.time()
    key = f"{message.id}_{type}"

    # é™åˆ¶æ›´æ–°é¢‘ç‡ï¼šæ¯ç§’æœ€å¤šæ›´æ–°ä¸€æ¬¡
    if key in last_update_time and now - last_update_time[key] < 1:
        return

    if key in last_update_time:
        elapsed = now - last_update_time[key]
        diff = current - last_update_bytes[key]
        speed = diff / elapsed if elapsed > 0 else 0
        speed_str = sizeof_fmt(speed) + "/s"
    else:
        speed_str = "è®¡ç®—ä¸­..."

    percent = current * 100 / total
    status_text = f"{percent:.1f}% - {speed_str}"

    with open(f'{message.id}{type}status.txt', "w") as fileup:
        fileup.write(status_text)

    last_update_time[key] = now
    last_update_bytes[key] = current


# å¼€å§‹å‘½ä»¤å¤„ç†å‡½æ•°
@bot.on_message(filters.command(["start"]))
def send_start(client: pyrogram.client.Client, message: pyrogram.types.messages_and_media.message.Message):
    if not is_allowed_user(message):
        return

    bot.send_message(message.chat.id,
                     f"__ğŸ‘‹ Hi **{message.from_user.mention}**, I am Save File Bot\nä½ å¯ä»¥å‘é€æ–‡ä»¶æˆ–å—é™å†…å®¹çš„é“¾æ¥è®©æˆ‘ä¿å­˜__\n\n{USAGE}",
                     reply_markup=InlineKeyboardMarkup(
                         [[InlineKeyboardButton("ğŸŒ æºç ä»“åº“", url="https://github.com/feassh/Save-File-Bot")]]),
                     reply_to_message_id=message.id)


# æ”¶åˆ°è§†é¢‘æˆ–å›¾ç‰‡æ‰§è¡Œ
@bot.on_message((filters.photo | filters.video | filters.document) & filters.private)
def save_media(client, message):
    if not is_allowed_user(message):
        return
    handle_private(message)


# æ”¶åˆ°â€œhttps://t.me/***â€åæ‰§è¡Œ
@bot.on_message(filters.text & filters.private)
def save(client: pyrogram.client.Client, message: pyrogram.types.messages_and_media.message.Message):
    if not is_allowed_user(message):
        return

    text = message.text.strip()

    # æ”¶åˆ°æ¶ˆæ¯
    if text.startswith("https://t.me/"):
        try:
            datas = text.split("/")
            msgid = int(datas[-1].replace("?single", "").split("-")[0])
        except Exception as e:
            bot.send_message(message.chat.id, f"**é”™è¯¯** : __{e}__", reply_to_message_id=message.id)
            return

        try:
            if len(datas) < 4: return
            # ç§äººçš„èŠå¤©
            if text.startswith("https://t.me/c/"):
                bot.send_message(message.chat.id, f"**é”™è¯¯** : æš‚ä¸æ”¯æŒç§äººèŠå¤©", reply_to_message_id=message.id)
            # æœºå™¨äººçš„èŠå¤©
            elif text.startswith("https://t.me/b/"):
                bot.send_message(message.chat.id, f"**é”™è¯¯** : æš‚ä¸æ”¯æŒæœºå™¨äººèŠå¤©", reply_to_message_id=message.id)
            # å…¬å¼€çš„èŠå¤©
            else:
                username = datas[3]

                try:
                    msg = bot.get_messages(username, msgid)
                except UsernameNotOccupied:
                    bot.send_message(message.chat.id, f"**ä¸å­˜åœ¨è¿™ä¸ªç”¨æˆ·å**", reply_to_message_id=message.id)
                    return

                try:
                    handle_private(message, msg=msg)
                except Exception as e:
                    bot.send_message(message.chat.id, f"**é”™è¯¯** : __{e}__", reply_to_message_id=message.id)
        except Exception as e:
            bot.send_message(message.chat.id, f"**é”™è¯¯** : __{e}__", reply_to_message_id=message.id)
    elif text.startswith("magnet:?") or text.startswith("http://") or text.startswith("https://"):
        smsg = bot.send_message(message.chat.id, "__å¼€å§‹ä¸‹è½½__", reply_to_message_id=message.id)

        try:
            # Magnet download using aria2c
            if text.startswith("magnet:?"):
                filename = f"downloads/{int(time.time())}_magnet"
                cmd = ["aria2c", text, "--dir=downloads", "--out=result", "--summary-interval=1"]
            else:
                # Direct HTTP/HTTPS download
                parsed = urlparse(text)
                filename = f"downloads/{os.path.basename(parsed.path) or str(int(time.time()))}"
                cmd = ["aria2c", text, "--dir=downloads", f"--out={os.path.basename(filename)}", "--summary-interval=1"]

            subprocess.run(cmd, check=True)

            if os.path.exists(filename):
                handle_file_upload(message, filename, smsg)
            else:
                bot.edit_message_text(message.chat.id, smsg.id, "ä¸‹è½½å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ–‡ä»¶")
                # # æœç´¢ä¸‹è½½ç›®å½•ä¸‹æœ€æ–°æ–‡ä»¶
                # files = sorted(os.listdir("downloads"), key=lambda x: os.path.getmtime(os.path.join("downloads", x)),
                #                reverse=True)
                # if files:
                #     latest = os.path.join("downloads", files[0])
                #     handle_file_upload(message, latest, smsg)
                # else:
                #     bot.edit_message_text(message.chat.id, smsg.id, "ä¸‹è½½å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ–‡ä»¶")
        except Exception as e:
            bot.edit_message_text(message.chat.id, smsg.id, f"ä¸‹è½½å¤±è´¥: {e}")
    else:
        return


# å¤„ç†ç§äººçš„èŠå¤©
def handle_private(message: pyrogram.types.messages_and_media.message.Message, msg=None):
    msg_user = message
    if msg is not None:
        msg_source = msg
    else:
        msg_source = message

    msg_type = get_message_type(msg_source)

    if "Other" == msg_type:
        bot.send_message(msg_user.chat.id, f"**é”™è¯¯** : æš‚ä¸æ”¯æŒä¿å­˜è¯¥ç±»å‹çš„å†…å®¹", entities=msg.entities,
                         reply_to_message_id=msg_user.id)
        return

    smsg = bot.send_message(msg_user.chat.id, '__ä¸‹è½½ä¸­__', reply_to_message_id=msg_user.id)
    dosta = threading.Thread(target=lambda: downstatus(f'{msg_source.id}downstatus.txt', smsg), daemon=True)
    dosta.start()
    file = bot.download_media(msg_source, progress=progress, progress_args=[msg_source, "down"])
    os.remove(f'{msg_source.id}downstatus.txt')

    upsta = threading.Thread(target=lambda: upstatus(f'{msg_source.id}upstatus.txt', smsg), daemon=True)
    upsta.start()

    if "Video" == msg_type:
        try:
            thumb = bot.download_media(msg_source.video.thumbs[0].file_id)
        except:
            thumb = None

        # å‘é€åˆ°æŒ‡å®šèŠå¤©
        bot.send_video(save_to_chat_id, file, duration=msg_source.video.duration, width=msg_source.video.width,
                       height=msg_source.video.height, has_spoiler=True, thumb=thumb, progress=progress,
                       progress_args=[msg_source, "up"],
                       reply_to_message_id=save_to_topic_id_video)
        if thumb is not None: os.remove(thumb)
    elif "Photo" == msg_type:
        # å‘é€åˆ°æŒ‡å®šèŠå¤©
        bot.send_photo(save_to_chat_id, file, has_spoiler=True,
                       reply_to_message_id=save_to_topic_id_photo)
    elif "Document" == msg_type:
        try:
            thumb = bot.download_media(msg_source.document.thumbs[0].file_id)
        except:
            thumb = None

        # å‘é€åˆ°æŒ‡å®šèŠå¤©
        bot.send_document(save_to_chat_id, file, thumb=thumb,
                          progress=progress,
                          progress_args=[msg_source, "up"], reply_to_message_id=save_to_topic_id_document)
        if thumb is not None: os.remove(thumb)

    os.remove(file)
    if os.path.exists(f'{msg_source.id}upstatus.txt'): os.remove(f'{msg_source.id}upstatus.txt')
    # åˆ é™¤ç”¨æˆ·å‘é€çš„èŠå¤©
    bot.delete_messages(msg_user.chat.id, [smsg.id])


# è·å–æ¶ˆæ¯ç±»å‹
def get_message_type(msg: pyrogram.types.messages_and_media.message.Message):
    try:
        msg.video.file_id
        return "Video"
    except:
        pass

    try:
        msg.photo.file_id
        return "Photo"
    except:
        pass

    try:
        msg.document.file_id
        return "Document"
    except:
        pass

    return "Other"


def handle_file_upload(message, file_path, status_msg):
    file_size = os.path.getsize(file_path)
    file_name = os.path.basename(file_path)
    suffix = os.path.splitext(file_name)[1].lower()

    upsta = threading.Thread(target=lambda: upstatus(f'{message.id}upstatus.txt', status_msg), daemon=True)
    upsta.start()

    try:
        if suffix in ['.mp4', '.mkv', '.mov', 'flv', '.avi', '.wmv', '.webm', '.m4v']:
            try:
                # è·å–è§†é¢‘ä¿¡æ¯
                clip = VideoFileClip(file_path)
                duration = int(clip.duration)
                width, height = clip.size
                clip.close()

                # ç”Ÿæˆç¼©ç•¥å›¾
                cap = cv2.VideoCapture(file_path)
                ret, frame = cap.read()
                thumb_path = f"{file_path}.jpg"
                if ret:
                    cv2.imwrite(thumb_path, frame)
                cap.release()
            except Exception as e:
                duration, width, height, thumb_path = None, None, None, None

            bot.send_video(
                save_to_chat_id,
                file_path,
                duration=duration,
                width=width,
                height=height,
                thumb=thumb_path if os.path.exists(thumb_path) else None,
                progress=progress,
                progress_args=[message, "up"],
                reply_to_message_id=save_to_topic_id_video
            )

            if thumb_path and os.path.exists(thumb_path):
                os.remove(thumb_path)
        elif suffix in ['.jpg', '.jpeg', '.png', '.webp', 'gif']:
            bot.send_photo(save_to_chat_id, file_path, reply_to_message_id=save_to_topic_id_photo)
        else:
            bot.send_document(
                save_to_chat_id,
                file_path,
                progress=progress,
                progress_args=[message, "up"],
                reply_to_message_id=save_to_topic_id_document
            )

        bot.edit_message_text(message.chat.id, status_msg.id, f"âœ… å·²ä¿å­˜ï¼š`{file_name}` ({sizeof_fmt(file_size)})")
    except Exception as e:
        bot.edit_message_text(message.chat.id, status_msg.id, f"âŒ ä¸Šä¼ å¤±è´¥: {e}")
    finally:
        if os.path.exists(file_path):
            os.remove(file_path)
        if os.path.exists(f'{message.id}upstatus.txt'):
            os.remove(f'{message.id}upstatus.txt')


USAGE = """**å¯¹äºå…¬å¼€èŠå¤©çš„æ–‡ä»¶**

__åªéœ€å‘é€ç›¸åº”é“¾æ¥__

**å¯¹äºéå…¬å¼€èŠå¤©çš„æ–‡ä»¶**

__é¦–å…ˆå‘é€èŠå¤©çš„é‚€è¯·é“¾æ¥ (å¦‚æœå½“å‰æä¾›ä¼šè¯çš„å¸æˆ·å·²ç»æ˜¯èŠå¤©æˆå‘˜ï¼Œåˆ™ä¸éœ€è¦å‘é€é‚€è¯·é“¾æ¥)
ç„¶åå‘é€é“¾æ¥__

**å¯¹äºæœºå™¨äººèŠå¤©**

__å‘é€å¸¦æœ‰â€œ/b/â€çš„é“¾æ¥ã€æœºå™¨äººçš„ç”¨æˆ·åå’Œæ¶ˆæ¯ IDï¼Œä½ å¯èƒ½éœ€è¦å®‰è£…ä¸€äº›éå®˜æ–¹å®¢æˆ·ç«¯æ¥è·å–å¦‚ä¸‹æ‰€ç¤ºçš„ ID__

```
https://t.me/b/botusername/4321
```

**å¦‚æœä½ éœ€è¦ä¸€æ¬¡ä¿å­˜å¤šä¸ªå—é™æ–‡ä»¶**

__å‘é€å…¬å…±/ç§äººå¸–å­é“¾æ¥ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨æ ¼å¼â€œå‘ä»¶äºº - æ”¶ä»¶äººâ€å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤º__

```
https://t.me/xxxx/1001-1010

https://t.me/c/xxxx/101 - 120
```

__æœ€å¥½åœ¨ä¸­é—´åŠ ä¸Šç©ºæ ¼__

__âš ï¸æ³¨æ„ï¼š__é¦–æ¬¡å°†æœºå™¨äººæ‹‰å…¥ç¾¤ç»„åï¼Œè¯·å…ˆåœ¨ç¾¤ç»„å‘é€ä»»æ„ä¸€æ¡æ¶ˆæ¯ï¼Œå¦åˆ™æœºå™¨äººä¼šä¸è¯†åˆ« ChatID
"""

# å¯åŠ¨æœºå™¨äººï¼ˆè¿›å…¥æ— é™è½®è¯¢ï¼‰
print("Bot is running...")
bot.run()
